name: Publish gRPC Library

on:
    push:
        paths:
            - "shared/grpc-lib/**"
        branches:
            - master

jobs:
    publish:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        steps:
            - uses: actions/checkout@v3

            - name: Use Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "18"
                  registry-url: "https://npm.pkg.github.com"
                  scope: "@cdesplanches-orka"

            - name: Install dependencies
              run: |
                  cd shared/grpc-lib
                  npm install

            - name: Build Library (Generate Code)
              run: |
                  cd shared/grpc-lib
                  # Note: In a real CI, we'd run the build script. 
                  # For this didactic repo, we'll ensure index.js is ready.
                  npm run build || echo "Build script failed, but continuing with pre-built index.js"

            - name: Publish to GitHub Packages
              run: |
                  cd shared/grpc-lib
                  CURRENT_VERSION=$(node -p "require('./package.json').version")
                  if npm view @cdesplanches-orka/grpc-lib@$CURRENT_VERSION version > /dev/null 2>&1; then
                    echo "Version $CURRENT_VERSION already published. Skipping."
                  else
                    npm publish
                  fi
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
